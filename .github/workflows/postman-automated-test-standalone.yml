name: Automated API tests using Postman CLI (Standalone)

on:
  pull_request:
    branches:
      - '*'
  workflow_dispatch:

jobs:
  automated-api-tests:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build webserv
        run: make

      - name: Make executable
        run: chmod +x ./webserv

      - name: Install Postman CLI
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh

      - name: Login Postman
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Start webserv
        run: |
          ./webserv config-files/valid/postman-test.conf &
          echo $! > server.pid

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/ | grep -qE "^[23]"; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet..."
            sleep 1
          done
          echo "Server failed to start"
          exit 1

      - name: Run Postman tests
        id: tests
        run: |
          postman collection run "52021088-0ff5ccb2-57f6-4b42-a0a1-da75fb99035b" \
            -e "52021088-580ece52-37d3-4dd2-9ca1-a242d70d68b0" \
            -r json --reporter-json-export report.json

      - name: Log summary
        if: always()
        run: |
          if [ -f report.json ]; then
            echo "Passed: $(jq '.run.stats.assertions.passed' report.json)/$(jq '.run.stats.assertions.total' report.json)"
          else
            echo "No report generated"
          fi

      - name: Cleanup
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi
